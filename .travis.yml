language: generic
dist: trusty
sudo: required
python:
  - 2.7
os:
  - linux
  - osx

env:
  # GitKraken
  - ANSIBLE_TAGS=gitkraken
  # Elixir and Erlang
  - ANSIBLE_TAGS=erlang,elixir

notifications:
  email: false

install: 
  - sudo pip install urllib3 pyopenssl ndg-httpsclient pyasn1
  - sudo pip install git+git://github.com/ansible/ansible.git@stable-2.2


before_script:
  # https://github.com/travis-ci/travis-ci/issues/6307
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then rvm get head || true; fi

script:
  - git config --global user.name "Test name"
  - git config --global user.email "test@localhost"
  
  # Run init only
  - ./setup --skip-playbook

  # Check syntax only
  - ansible-playbook main.yml --syntax-check

  # Run playbooks with the selected tags only
  - ansible-playbook main.yml --tags=$ANSIBLE_TAGS
  - >
    ansible-playbook main.yml --tags=$ANSIBLE_TAGS
    | grep -q 'changed=0.*failed=0'
    && (echo 'Idempotence test: pass' && exit 0)
    || (echo 'Idempotence test: fail' && exit 1)